我们来全面解析 Rust 中的**函数 (Functions)**。函数是 Rust 代码结构的核心，是组织代码、实现复用和构建抽象的基本单元。理解函数的细节对于编写任何有意义的 Rust 程序都至关重要。

---

### 1. 函数的基础

在 Rust 中，函数无处不在。你已经见过了最重要的函数：`main` 函数，它是所有二进制程序的入口点。

**核心理念**：Rust 要求函数和变量名使用 **蛇形命名法 (`snake_case`)**。即所有字母小写，单词之间用下划线分隔。

#### 函数的解剖结构

一个基本的 Rust 函数定义包含以下部分：

1.  **`fn` 关键字**：用于声明一个新函数。
2.  **函数名**：例如 `main`, `do_something`。
3.  **参数列表 (Parameters)**：在圆括号 `()` 内，用于接收传入函数的值。
4.  **返回类型 (Return Type)**：在箭头 `->` 之后，显式声明函数将返回的值的类型。
5.  **函数体 (Body)**：在花括号 `{}` 内，包含函数的具体执行代码。

```rust
//      (2)         (3)参数列表       (4)返回类型
// fn function_name(param1: Type1, param2: Type2) -> ReturnType {
//     // (5) 函数体
//     // ... some code ...
// }
```

---

### 2. 参数 (Parameters)：向函数传递信息

函数参数是函数的输入。一个非常重要的 Rust 特性是：**必须为每个函数参数显式声明其类型**。

这是 Rust 实现类型安全和编译时检查的关键一环。编译器不会为你推断参数的类型。

#### 示例：带参数的函数

```rust
fn main() {
    // 调用函数并传入参数
    print_measurement(5, 'h'); 
}

// 定义一个函数，它接收一个 i32 类型的整数和一个 char 类型的字符
fn print_measurement(value: i32, unit_label: char) {
    println!("The measurement is: {}{}", value, unit_label);
}
```

**面试/实战要点**：
*   **类型注解是强制的**：忘记为参数添加类型是初学者常见的编译错误。这体现了 Rust 的“明确性”哲学。
*   **所有权**：参数的传递遵循 Rust 的所有权规则。对于简单类型（如 `i32`, `char`, `bool`），值会被复制。对于复杂类型（如 `String`），所有权会被移动或借用，这是后续课程的重点。

---

### 3. 函数体：语句 (Statements) vs. 表达式 (Expressions)

这是 Rust 函数中最核心、最独特，也是**面试中最高频**的考点。理解这一点是编写地道 Rust 代码的关键。

*   **语句 (Statements)**：是执行某些操作但不返回值的指令。在 Rust 中，语句以**分号 `;`** 结尾。
    *   例如：`let x = 6;` 是一个语句。它本身没有值。你不能写 `let y = (let x = 6);`。

*   **表达式 (Expressions)**：会计算并产生一个值。
    *   例如：`5 + 6` 是一个表达式，其计算结果是 `11`。
    *   函数调用是一个表达式。
    *   宏调用是一个表达式。
    *   花括号 `{}` 创建的代码块也是一个表达式。
    *   **关键**：在表达式的末尾**加上分号**，会把它变成一个语句（其值为 `()`，即空元组）。

#### 示例：表达式的力量

```rust
fn main() {
    // 整个 `{}` 块是一个表达式
    let y = {
        let x = 3;
        x + 1 // 注意这里没有分号！
              // 这个表达式的值 (4) 会被绑定到 y 上
    };

    println!("The value of y is: {}", y); // 输出 4

    let z = {
        let x = 3;
        x + 1; // 注意这里有分号！
               // 这变成了一个语句，整个代码块的表达式值为 ()
    };
    
    // 下面的 println! 会报错，因为 z 的类型是 ()，无法用 {} 格式化
    // println!("The value of z is: {:?}", z); 
}
```

---

### 4. 返回值 (Return Values)

函数可以通过 `->` 语法声明它的返回类型。在 Rust 中，有两种方式从函数返回值：

1.  **使用 `return` 关键字**：可以从函数中**提前**返回。
2.  **使用函数体最后的表达式**：这是**最常用、最地道**的方式。函数会自动返回其函数体中最后一个表达式的值。

#### 示例 1：隐式返回 (Idiomatic Rust)

```rust
fn main() {
    let x = five();
    println!("The value of x is: {}", x); // 输出 5

    let y = plus_one(x);
    println!("The value of y is: {}", y); // 输出 6
}

// 这个函数返回一个 i32 类型的值
fn five() -> i32 {
    5 // 没有分号，这是一个表达式，它的值 5 将被返回
}

fn plus_one(num: i32) -> i32 {
    num + 1 // 同样，没有分号，表达式 `num + 1` 的结果将被返回
}
```
**常见陷阱**：在 `num + 1` 后面不小心加了分号，`num + 1;` 就会变成一个语句，函数的返回值会变为 `()`，这会导致与函数签名 `-> i32` 不匹配而编译失败。编译器会给出非常清晰的错误提示。

#### 示例 2：使用 `return` 显式返回

当你需要在函数中间根据条件退出时，`return` 关键字就派上用场了。

```rust
fn find_first_even(numbers: &[i32]) -> Option<i32> {
    for &num in numbers {
        if num % 2 == 0 {
            // 找到了第一个偶数，立即返回
            return Some(num);
        }
    }
    // 循环结束也没找到，返回 None
    None
}

fn main() {
    let my_numbers = [1, 3, 5, 4, 7, 8];
    let first_even = find_first_even(&my_numbers);
    println!("The first even number is: {:?}", first_even); // 输出 Some(4)
}
```

### 5. 函数签名 (Function Signature)

函数签名是函数的定义，它由函数名、参数列表（及其类型）和返回类型组成。它是函数的“契约”，告诉调用者如何正确地使用这个函数。

```rust
// 函数签名是：fn calculate_area(width: u32, height: u32) -> u32
fn calculate_area(width: u32, height: u32) -> u32 {
    width * height
}
```

### 6. 特殊的返回类型

#### 不返回任何值：`()` (Unit Type)
如果一个函数不返回任何有意义的值，它的返回类型是 `()`，称为**单元类型 (Unit Type)**。`()` 是一个零大小的元组。

你可以省略 `-> ()`，编译器会自动推断。

```rust
// 这个函数签名等价于 fn log_message(message: &str) -> ()
fn log_message(message: &str) {
    println!("[LOG]: {}", message);
    // 这个函数隐式返回 ()
}
```

#### 永不返回：`!` (Never Type)
这是一个更高级的类型，称为**发散函数 (Diverging Function)**。当一个函数保证永远不会返回时（例如，它会调用 `panic!` 宏、无限循环或退出进程），它的返回类型是 `!`，称为“never type”。

```rust
fn crash_and_burn() -> ! {
    panic!("This function never returns!");
}
```
你暂时不需要编写这种函数，但当你在阅读标准库或其他库的源码时，理解 `!` 的含义会很有帮助。

### 总结与实战建议

1.  **永远明确类型**：函数的参数和返回值必须有明确的类型注解。这是 Rust 安全性的基石。
2.  **拥抱表达式**：学习并习惯使用代码块和函数体的最后一个表达式作为返回值。这是编写简洁、优雅 Rust 代码的关键。
3.  **分号很重要**：要时刻注意分号，它决定了你的代码是语句还是表达式，直接影响返回值。
4.  **单一职责**：好的函数应该只做一件事，并把它做好。这让代码更容易测试、复用和理解。
5.  **文档注释**：对于公开的函数 (public functions)，使用 `///` 来添加文档注释。`cargo doc` 工具可以为你生成漂亮的 HTML 文档。

```rust
/// Calculates the sum of two integers.
///
/// # Examples
///
/// ```
/// let result = my_crate::add(2, 2);
/// assert_eq!(result, 4);
/// ```
fn add(a: i32, b: i32) -> i32 {
    a + b
}
```
