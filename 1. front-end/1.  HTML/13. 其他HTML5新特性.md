### **第四节：其他HTML5新特性**

#### **1. 表单增强**

我们在之前的表单章节已经详细介绍过`email`, `number`, `date`, `color`, `range`等新的`input`类型。这里我们重点回顾并补充**表单验证**相关的属性，这些属性让浏览器具备了基础的数据校验能力，大大减轻了前端JavaScript验证的负担。

##### **表单验证属性**

这些属性都是布尔属性，直接写在 `input`、`textarea` 或 `select` 标签上即可。

*   **`required`**
    *   **作用**：规定该输入字段为**必填项**。如果用户未填写就尝试提交表单，浏览器会阻止提交并显示提示信息。
    *   **示例**：
        ```html
        <label for="username">用户名:</label>
        <input type="text" id="username" name="username" required>
        ```

*   **`pattern`**
    *   **作用**：提供一个**正则表达式**，用于验证输入值的格式是否正确。这是最强大的验证属性。
    *   **示例**：验证一个由3到15个字母或数字组成的用户名。
        ```html
        <label for="uid">用户ID (3-15位字母或数字):</label>
        <input type="text" id="uid" name="uid" pattern="[A-Za-z0-9]{3,15}" title="请输入3到15位的字母或数字">
        ```        *`title` 属性在这里非常有用，当验证失败时，浏览器会把 `title` 的内容作为提示信息的一部分显示给用户。*

*   **`min` 和 `max`**
    *   **作用**：用于 `number`, `range`, `date` 等类型，规定允许的最小值和最大值。
    *   **示例**：
        ```html
        <label for="age">年龄:</label>
        <input type="number" id="age" name="age" min="18" max="99">
        ```

*   **`step`**
    *   **作用**：规定数值的合法步长间隔。
    *   **示例**：要求输入0到100之间的偶数。
        ```html
        <input type="number" name="even" min="0" max="100" step="2">
        ```

*   **`maxlength`**
    *   **作用**：规定输入字段允许的**最大字符数**。
    *   **示例**：
        ```html
        <label for="short_desc">简介 (最多50字):</label>
        <textarea id="short_desc" name="desc" maxlength="50"></textarea>
        ```

**组合使用示例**：创建一个复杂的密码输入框。
```html
<label for="pwd">密码:</label>
<input 
    type="password" 
    id="pwd" 
    name="password"
    required
    minlength="8" 
    pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}"
    title="密码必须至少包含8个字符，且同时包含大小写字母和数字。">
```
*这个例子要求密码必填、最小长度为8，并且通过正则表达式强制要求必须同时包含大写字母、小写字母和数字。*

---

#### **2. 本地存储：`LocalStorage` 和 `SessionStorage` (重点)**

在HTML5出现之前，前端要在浏览器端存储数据，主要依赖于`cookies`。但`cookies`存在很多问题：大小只有4KB左右、每次HTTP请求都会被自动带上（浪费带宽）、操作API不友好。

HTML5的 **Web Storage API** 完美地解决了这些问题，它提供了两种在浏览器端存储数据的机制：`LocalStorage` 和 `SessionStorage`。

##### **核心概念**

*   它们都是 **键值对 (key-value) 存储**，键和值都必须是**字符串**。
*   它们都属于 **同源策略** 的一部分。也就是说，一个网站 (`http://a.com`) 创建的Storage，另一个网站 (`http://b.com`) 是无法访问的。
*   它们都通过 `window` 对象上的 `localStorage` 和 `sessionStorage` 属性来访问。

##### **`LocalStorage` - 持久化本地存储**

*   **生命周期**：**永久有效**。除非用户**手动清除浏览器缓存**或Web应用通过代码主动删除，否则存储的数据将永远保留在用户的电脑上，即使关闭浏览器、关闭电脑、重启电脑，数据依然存在。
*   **作用域**：在**同一个浏览器**中，所有**同源**（协议、域名、端口号都相同）的窗口和标签页之间**共享数据**。你在 `a.com` 的一个标签页中存入数据，在 `a.com` 的另一个标签页中可以立即读到。
*   **容量**：通常为 **5MB** 左右（不同浏览器略有差异），远大于`cookies`。
*   **适用场景**：
    *   存储用户的偏好设置（如网站主题色、字体大小）。
    *   记录用户不希望丢失的本地数据（如“记住我”登录状态、购物车内容）。
    *   缓存不常变动的网站数据（如网站配置信息），减少HTTP请求。

##### **`SessionStorage` - 会话级本地存储**

*   **生命周期**：**仅在当前浏览器会话（session）期间有效**。一个会话指的是从**打开一个标签页**到**关闭这个标签页**。
    *   **关闭标签页或浏览器，`SessionStorage` 中的数据会被自动清除**。
    *   在当前标签页内刷新页面或恢复页面，数据**依然存在**。
*   **作用域**：数据**仅在当前标签页内可用**，不同标签页之间的 `SessionStorage` 是**隔离的、不共享的**，即使它们是同源的。你在 `a.com` 的一个标签页存入数据，在 `a.com` 的另一个新开的标签页中是**读不到**的。
*   **容量**：和`LocalStorage`相同，通常为5MB左右。
*   **适用场景**：
    *   存储本次会话中需要用到的临时数据，避免数据在不同页面跳转时丢失（如多步骤表单的填写过程）。
    *   存储一些只对当前任务有用的敏感信息，确保标签页关闭后自动销毁。

##### **Web Storage API 用法 (LocalStorage 和 SessionStorage 完全一致)**

操作它们的API非常简单，只有四个核心方法和一个属性：

*   **`setItem(key, value)`**: 存储或更新一个键值对。
    ```javascript
    // 存储用户名
    localStorage.setItem('username', 'Alice');
    // 存储一个对象（需要先序列化为JSON字符串）
    const userSettings = { theme: 'dark', fontSize: 16 };
    localStorage.setItem('settings', JSON.stringify(userSettings));
    ```

*   **`getItem(key)`**: 根据键来获取对应的值。如果键不存在，返回 `null`。
    ```javascript
    const username = localStorage.getItem('username'); // "Alice"
    // 取出对象（需要反序列化为JS对象）
    const settingsStr = localStorage.getItem('settings');
    const settings = JSON.parse(settingsStr); // { theme: 'dark', fontSize: 16 }
    ```

*   **`removeItem(key)`**: 根据键来删除一个键值对。
    ```javascript
    localStorage.removeItem('username');
    ```

*   **`clear()`**: 清空该域名下**所有**的存储数据。
    ```javascript
    localStorage.clear();
    ```

*   **`length` 属性**: 获取已存储的键值对的数量。
    ```javascript
    const count = localStorage.length;
    ```
*   **点语法/方括号语法 (不推荐)**: 你也可以像操作普通对象一样操作Storage，但不推荐这样做，因为它可能与Storage原型链上的方法名冲突。
    ```javascript
    localStorage.username = 'Bob'; // 等同于 setItem
    console.log(localStorage['username']); // 等同于 getItem
    delete localStorage.username; // 等同于 removeItem
    ```

**如何查看**：打开浏览器开发者工具 (F12)，找到 "Application" (应用) 或 "Storage" (存储) 标签页，在左侧菜单中就能看到 Local Storage 和 Session Storage，并可以查看、修改、删除已存储的数据。

---

#### **3. Web Workers：后台运行脚本**

* **核心概念**：JavaScript是单线程的。这意味着在同一时间，它只能做一件事。如果一个任务非常耗时（例如，进行大量的复杂计算、处理大文件），它就会**阻塞**主线程，导致整个网页UI卡顿，用户无法进行任何操作，体验极差。

* **Web Worker 的作用**：它允许你创建一个**在后台运行**的、完全独立于主线程的**子线程**。你可以把耗时的任务交给这个Worker去做，主线程则继续负责UI的响应，保持页面的流畅。当Worker完成任务后，可以通过一个消息机制将结果返回给主线程。

*   **基本用法**（了解概念即可）：
    *   **主线程 (`main.js`)**:
        ```javascript
        // 1. 创建一个新的Worker
        const myWorker = new Worker('worker.js');
        
        // 2. 向Worker发送消息
        myWorker.postMessage([5, 3]);
        
        // 3. 监听来自Worker的消息
        myWorker.onmessage = function(e) {
            console.log('主线程收到了结果:', e.data); // '主线程收到了结果: 8'
        };
        
        ```
        
    * **Worker脚本 (`worker.js`)**:
    
    ```javascript
    // 1. 监听来自主线程的消息
    onmessage = function(e) {
        console.log('Worker收到了数据:', e.data); // 'Worker收到了数据: [5, 3]'
        const result = e.data[0] + e.data[1];
        // 2. 将结果发送回主线程
        postMessage(result);
    };

---

#### **4. 地理定位API (Geolocation API)**

*   **核心概念**：这是一个允许Web应用获取用户**地理位置信息**（经纬度）的API。
*   **隐私**：出于隐私和安全考虑，浏览器在获取用户位置前，**必须弹窗并明确请求用户的授权**。只有用户点击“允许”后，脚本才能获取到位置信息。如果用户拒绝，将无法获取。此外，该API在 `https:` (HTTPS) 协议下才能保证正常工作。
*   **基本用法**：通过 `navigator.geolocation` 对象来访问。
    *   `getCurrentPosition(successCallback, errorCallback)`: 获取用户当前的位置。

    ```javascript
    if (navigator.geolocation) {
        // 请求用户授权
        navigator.geolocation.getCurrentPosition(
            // 成功的回调函数
            function(position) {
                const latitude = position.coords.latitude; // 纬度
                const longitude = position.coords.longitude; // 经度
                console.log(`你的位置是：纬度 ${latitude}, 经度 ${longitude}`);
                // 在这里可以调用地图API来显示位置
            },
            // 失败的回调函数
            function(error) {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        console.error("用户拒绝了地理位置请求。");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        console.error("位置信息不可用。");
                        break;
                    case error.TIMEOUT:
                        console.error("请求超时。");
                        break;
                    case error.UNKNOWN_ERROR:
                        console.error("发生未知错误。");
                        break;
                }
            }
        );
    } else {
        console.error("你的浏览器不支持地理定位。");
    }
    ```

**本节总结**
我们学习了HTML5的一些高级特性：
*   **表单增强**：通过内置验证属性实现了更强大的前端校验。
*   **本地存储**：`LocalStorage` 用于持久化存储，`SessionStorage` 用于会话级存储，它们提供了强大、易用的客户端数据存储方案。
*   **Web Workers**：通过在后台运行脚本来解决JavaScript单线程的阻塞问题，提升应用性能。
*   **地理定位**：在用户授权的前提下，获取设备的地理位置信息。

这些API极大地扩展了Web应用的能力边界，是构建现代化、富交互应用的基础。
